{% extends "layout.html" %}

{% block title %}
{{ errand[1] }} <!-- Title of the errand -->
{% endblock %}

{% block main %}
<div class="container mt-5">
    <h2>{{ errand[1] }}</h2> <!-- Title -->
    <p>Published by {{ errand[3] }} - on {{ errand[4] }}</p>
    <p>{{ errand[2] }}</p> <!-- Description -->

    <!-- Executed Button -->
    <div class="text-end mt-3">
        <a href="{{ url_for('executed', errand_id=errand[0]) }}" class="btn btn-primary" id="executed-btn" style="display: none;">Executed</a>
    </div>
    
    <!-- Optout button -->
    <div class="text-end mt-3">
        <a href="{{ url_for('opt_out', errand_id=errand[0]) }}" class="btn btn-primary" id="optout-btn" style="display: none;">Opt Out</a>
    </div>

    <!-- Execute Button -->
    <div class="text-end mt-3">
        <a href="{{ url_for('execute_errand', errand_id=errand[0]) }}" class="btn btn-primary" id="execute-btn">Execute</a>
    </div>

    {% if start_time is defined and start_time is not none %}
    <!-- Container for time display -->
    <div id="remaining-time-container">
        <p>Remaining Time: <span id="remaining-time"></span></p>
    </div>

    <script>
        window.addEventListener("DOMContentLoaded", function () {
            var start_time = {{ start_time|default('undefined')|tojson|safe }};
            
            if (start_time !== 'undefined') {
                var errandId = {{ errand[0]|tojson|safe }};
                var errandDuration = {{ errand[8] }};
                var remainingTimeContainer = document.getElementById("remaining-time-container");
                var remainingTimeElement = document.getElementById("remaining-time");
                var executeButton = document.getElementById("execute-btn");
                var executedButton = document.getElementById("executed-btn");
                var optoutButton = document.getElementById("optout-btn");

                if (executeButton) {
                    executeButton.addEventListener("click", function () {
                        // Calculate the remaining time on the client side
                        var timerId = setInterval(function () {
                            var current_time = new Date().getTime() / 1000; // Convert milliseconds to seconds
                            var elapsed_time = current_time - start_time;
                            var remaining_time = Math.max(0, errandDuration - elapsed_time);

                            // Show the container for time display
                            remainingTimeContainer.style.display = "block";

                            remainingTimeElement.textContent = remaining_time.toFixed(0) + " seconds";

                            // If the remaining time is zero, stop the timer
                            if (remaining_time === 0) {
                                clearInterval(timerId);
                            }
                        }, 1000);

                        // Hide the execute button and show executed and optout buttons
                        if (executeButton && executedButton && optoutButton) {
                            executeButton.style.display = "none";
                            executedButton.style.display = "inline-block";
                            optoutButton.style.display = "inline-block";
                        }
                    });
                }
            }
        });
    </script>

    {% else %}
    
    <script>
        // Hide the executed and optout buttons and show execute button
        var executeButton = document.getElementById("execute-btn");
        var executedButton = document.getElementById("executed-btn");
        var optoutButton = document.getElementById("optout-btn");

        if (executeButton && executedButton && optoutButton) {
            executeButton.style.display = "inline-block";
            executedButton.style.display = "none";
            optoutButton.style.display = "none";
        }
    </script>

    {% endif %}

    <div id="map" style="height: 400px;"></div>

    <script>
        function initMap() {
            var errandLocation = { lat: {{ errand[6] }}, lng: {{ errand[7] }} };

            var map = new google.maps.Map(document.getElementById('map'), {
                zoom: 15,
                center: errandLocation
            });
            new google.maps.Marker({
                position: errandLocation,
                map: map
            });
        }
    </script>
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAChcmJ-2WVKyBH9DpOwH5PcEoFPecNrpE&callback=initMap"></script>
</div>
{% endblock %}


