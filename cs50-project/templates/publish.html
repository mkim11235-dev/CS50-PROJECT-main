{% extends "layout.html" %}

{% block title %}
Publish
{% endblock %}

{% block main %}
<div class="container mt-5">
    <h2>Publish a Request</h2>
    <form action="/publish" method="post" id="publish-form">
        <div class="mb-3">
            <label for="title" class="form-label">Title</label>
            <input name="title" class="form-control" type="text" required>
        </div>
        <div class="mb-3">
            <label for="content" class="form-label">Describe your errand</label>
            <textarea name="content" class="form-control" required></textarea>
        </div>
        <div class="mb-3">
            <label for="duration" class="form-label">Duration (minutes)</label>
            <input name="duration" class="form-control" type="number" required>
        </div>
        <div class="mb-3">
            <label for="location" class="form-label">Location</label>
            <div id="map" style="height: 400px;"></div>
            <button type="button" id="use-current-location" class="btn btn-secondary mt-2">Use My Current
                Location</button>
        </div>
        <input type="hidden" name="latitude" id="latitude">
        <input type="hidden" name="longitude" id="longitude">
        <button class="btn btn-primary" type="submit">Publish</button>
    </form>
</div>

<script>
    let map, marker;

    // Initialize and add the map
    function initMap() {
        map = new google.maps.Map(document.getElementById("map"), {
            zoom: 4,
            center: { lat: -25.344, lng: 131.036 }, // Default center
        });

        marker = new google.maps.Marker({
            position: { lat: -25.344, lng: 131.036 },
            map: map,
            draggable: true
        });

        google.maps.event.addListener(marker, 'dragend', function () {
            document.getElementById('latitude').value = marker.getPosition().lat();
            document.getElementById('longitude').value = marker.getPosition().lng();
        });
    }

    // Use current location
    document.getElementById('use-current-location').addEventListener('click', function () {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function (position) {
                const userLocation = {
                    lat: position.coords.latitude,
                    lng: position.coords.longitude
                };
                map.setCenter(userLocation);
                marker.setPosition(userLocation);
                document.getElementById('latitude').value = userLocation.lat;
                document.getElementById('longitude').value = userLocation.lng;
            }, function (error) {
                alert('Error occurred. Error code: ' + error.code);
            });
        } else {
            alert('Geolocation is not supported by this browser.');
        }
    });
</script>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAChcmJ-2WVKyBH9DpOwH5PcEoFPecNrpE&callback=initMap" async
    defer></script>
{% endblock %}